# 昆仑海岸 KL-H1100 modbus 协议分析

## 网关通信初始化 ##

	握手包：15 01 22 22 00 10 + 网关序列号

	例：15 01 22 22 00 10 31 31 30 30 32 30 31 34 31 30 31 34 30 31 39 34
	序列号：1100201410140194

	响应包：15 01 22 22 00 01 80
	错误包：15 01 22 22 00 01 01
	
## 查询设备信息 ##
### 查网关IP	
	指令：15 01 00 00 00 06 FF 03 00 00 00 08
	返回: 15 01 00 00 00 13 FF 03 10 31 39 32 2E 31 36 38 2E 30 2E 32 32 32 0D 00 00
	IP值: [31 39 32 2E 31 36 38 2E 30 2E 32 32 32] -> [192.168.0.222]

### 查子网掩码
	发送：15 01 00 00 00 06 FF 03 00 08 00 08
	返回：15 01 00 00 00 13 FF 03 10 32 35 35 2E 32 35 35 2E 32 35 35 2E 30 0D 00 00
	值：[32 35 35 2E 32 35 35 2E 32 35 35 2E 30] -> [255.255.255.0]

### 查网关IP
	发送：15 01 00 00 00 06 FF 03 00 10 00 08
	返回：15 01 00 00 00 13 FF 03 10 31 39 32 2E 31 36 38 2E 30 2E 32 35 34 0D 00 00
	值：[31 39 32 2E 31 36 38 2E 30 2E 32 35 34] -> [192.168.0.254]

### 查网关序列号
	发送：15 01 00 00 00 06 FF 03 00 29 00 08
	返回：15 01 00 00 00 13 FF 03 10 31 31 30 30 32 30 31 34 31 30 31 34 30 31 39 34
	值：[31 31 30 30 32 30 31 34 31 30 31 34 30 31 39 34] -> [1100201410140194]

### 查MAC地址
	发送：15 01 00 00 00 06 FF 03 00 20 00 09
	返回：15 01 00 00 00 15 FF 03 12 32 30 3A 31 34 3A 31 30 3A 31 34 3A 30 31 3A 39 34 00
	结果：[32 30 3A 31 34 3A 31 30 3A 31 34 3A 30 31 3A 39 34] -> [20:14:10:14:01:94]

## 读线圈功能码 0x01
### 读64个节点在线状态
	发送：15 01 00 00 00 06 FF 01 55 55 00 40
	返回：15 01 00 00 00 0B FF 01 08 03 00 00 00 00 00 00 00
	结果：[03 00 00 00 00 00 00 00] 
		-> [每个节点数据转为二进制并分别按低到高位排序]
		-> [11000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000] 
		-> [第1、2个节点在线]

## 读节点通道数据

__知识点：__ 

-	1网关 x 64节点
-	1节点 x 32通道
-	1通道 x 2寄存器 x 4字节
-	一个通道接一路传感器

__数据名称代码对应关系__

- 01 温度
- 02 湿度
- 03 照度
- 14 CO2

**附：** [数据名称代码表](channel-code-list.md)

### 读设备地址为0x01的前4个通道数据
	发送：15 01 00 00 00 06 01 03 00 00 00 08
	返回：15 01 00 00 00 13 01 03 10 01 81 01 08 02 01 01 DC 03 00 01 D7 14 00 01 B0

#### 四个通道返回数据如下
	[01 81 01 08] 
		-> [01:温度; 81:有符号, 1位小数; 0x0108: 264]
		-> [温度值: 26.4℃] 
	[02 01 01 DC] -> [湿度: 47.6]
	[03 00 01 D7] -> [照度: 471]
	[14 00 01 B0] -> [CO2: 432]

### 读设备地址为0x02的第2个通道数据
	发送：15 01 00 00 00 06 02 03 00 02 00 02
	返回：15 01 00 00 00 07 02 03 04 02 01 01 ED
